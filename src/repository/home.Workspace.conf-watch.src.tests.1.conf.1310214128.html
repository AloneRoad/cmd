<span style="font-family: monospace; font-size: 12px;color: #333;"><pre>worker_processes 4;</pre><pre></pre><pre>pid logs/nginx.pid;</pre><pre></pre><pre>events {</pre><pre>  worker_connections  10240;</pre><pre>  use epoll;</pre><pre>}</pre><pre></pre><pre></pre><pre>http {</pre><pre>  upstream request_handlers {</pre><pre>    server 127.0.0.1:8888;</pre><pre>  }</pre><pre>  </pre><pre>  upstream upload_handlers {</pre><pre>    server 127.0.0.1:8888;</pre><pre>  }</pre><pre>  </pre><pre>  server_tokens off;</pre><pre>  include       mime.types;</pre><pre>  default_type  application/octet-stream;</pre><pre></pre><pre>  sendfile      off;</pre><pre>  tcp_nopush    on;</pre><pre>  tcp_nodelay   on;</pre><pre></pre><pre>  client_body_buffer_size     1K;</pre><pre>  client_header_buffer_size   1k;</pre><pre>  client_max_body_size        1k;</pre><pre>  large_client_header_buffers 2 1k;</pre><pre>  </pre><pre>  client_body_timeout   10;</pre><pre>  client_header_timeout 10;</pre><pre>  keepalive_timeout     5 5;</pre><pre>  send_timeout          10;</pre><pre></pre><pre>  gzip  on;</pre><pre>  gzip_min_length 1000;</pre><pre>  gzip_proxied any;              </pre><pre>  gzip_types text/plain text/css text/xml</pre><pre>             application/x-javascript application/xml</pre><pre>             application/atom+xml text/javascript;</pre><pre>  </pre><pre>  proxy_next_upstream     timeout;</pre><pre>  proxy_connect_timeout   60;</pre><pre></pre><pre>  proxy_temp_path /var/ramdisk/tmp/;</pre><pre>  proxy_max_temp_file_size  0;</pre><pre></pre><pre>  more_clear_headers ETag;</pre><pre>  more_set_headers 'Server: vws';</pre><pre>  expires       max;</pre><pre></pre><pre>  server {</pre><pre>    listen       80;</pre><pre>    client_max_body_size 2000M;</pre><pre>    </pre><pre>    location /status {</pre><pre>      stub_status on;</pre><pre>      access_log   off;</pre><pre>    }</pre><pre></pre><pre>    # Upload form should be submitted to this location</pre><pre>    location /upload {</pre><pre>      upload_pass @upload_handlers;</pre><pre>     </pre><pre>      # The directory is hashed, subdirectories 0 1 2 3 4 5 6 7 8 9 should exist</pre><pre>      upload_store /var/ramdisk 1;</pre><pre>       </pre><pre>      upload_store_access user:rw group:rw all:rw;</pre><pre>      upload_cleanup 400 404 499 500-505;</pre><pre>      </pre><pre>      upload_set_form_field $upload_field_name.name "$upload_file_name";</pre><pre>      upload_set_form_field $upload_field_name.content_type "$upload_content_type";</pre><pre>      upload_set_form_field $upload_field_name.temp_file "$upload_tmp_path";</pre><pre>      upload_aggregate_form_field $upload_field_name.md5 "$upload_file_md5";</pre><pre>      upload_aggregate_form_field $upload_field_name.size "$upload_file_size";</pre><pre>    }   </pre><pre>    </pre><pre>    location @upload_handlers {    </pre><pre>      proxy_pass http://upload_handlers;</pre><pre>    } </pre><pre>    </pre><pre>    ## Proxy download ##</pre><pre>    location ~* ^/dl/(.*?)/(.*) {</pre><pre>      internal;</pre><pre>  </pre><pre>      # Extract download url from the request</pre><pre>      set $download_uri $2;</pre><pre>      set $download_host $1;</pre><pre>  </pre><pre>      # Compose download url</pre><pre>      set $download_url http://$download_host/$download_uri;</pre><pre>  </pre><pre>      # Set download request headers</pre><pre>      proxy_set_header Host $download_host;</pre><pre>      proxy_set_header Authorization '';</pre><pre>      </pre><pre>      # Do not touch local disks when proxying </pre><pre>      # content to clients</pre><pre>      proxy_max_temp_file_size 0;</pre><pre>  </pre><pre>      # Fixes .fid content-type</pre><pre>      proxy_hide_header Content-Type;</pre><pre>      </pre><pre>      # Download the file and send it to client</pre><pre>      proxy_pass $download_url;</pre><pre>    }</pre><pre>        </pre><pre>    location / {</pre><pre>      </span><span style="font-family: monospace; font-size: 12px;background-color: #FDD; text-decoration: line-through; color: #333; opacity: 0.25;"></pre><pre>      </pre><pre>      </span><span style="font-family: monospace; font-size: 12px;color: #333;">proxy_pass_header Server;</pre><pre>      proxy_set_header Host $http_host;</pre><pre>      proxy_redirect off;</pre><pre>      proxy_set_header X-Real-IP $remote_addr;</pre><pre>      proxy_set_header X-Scheme $scheme;</span><span style="font-family: monospace; font-size: 12px;background-color: #FDD; text-decoration: line-through; color: #333; opacity: 0.25;"></pre><pre>       </span><span style="font-family: monospace; font-size: 12px;color: #333;"></pre><pre>      proxy_pass http://request_handlers;</pre><pre>    }</pre><pre>  }</pre><pre>}</pre><pre></pre></span>